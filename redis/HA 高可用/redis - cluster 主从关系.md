## Redis Cluster 主从关系
https://blog.csdn.net/liuxiao723846/article/details/86715614
集群主节点出现故障，发生故障转移，其他主节点会把故障主节点的从节点自动提为主节点，原来的主节点恢复后，自动成为新主节点的从节点

1. 集群间节点支持主从关系，复制的逻辑基本复用了单机版的实现
2. 集群间节点建立主从关系不再使用原有的SLAVEOF命令和SLAVEOF配置，而是通过cluster replicate命令，这保证了主从节点需要先完成握手，才能建立主从关系
3. 集群是不能组成链式主从关系的，也就是说从节点不能有自己的从节点
4. 集群内节点想要复制另一个节点，需要保证本节点不再负责任何slot，不然redis也是不允许的
5. 集群内的从节点在与其他节点通信的时候，传递的消息中数据分布表和epoch是master的值


### Redis Cluster 主从节点选举
https://blog.csdn.net/liuxiao723846/article/details/86715614  

集群内一个master和它的全部slave描述为一个group，故障转移是以group为单位的，集群故障转移的方式跟sentinel的实现类似
新的主节点由已下线主节点属下的所有从节点中自行选举产生，以下是选举的条件：
* 这个节点是已下线主节点的从节点。
* 已下线主节点负责处理的槽数量非空。
* 从节点的数据被认为是可靠的，也即是，主从节点之间的复制连接（replication link）的断线时长不能超过节点超时时限（node timeout）乘以REDIS_CLUSTER_SLAVE_VALIDITY_MULT 常量得出的积。
如果一个从节点满足了以上的所有条件，那么这个从节点将向集群中的其他主节点发送授权请求，询问它们，是否允许自己（从节点）升级为新的主节点。

如果发送授权请求的从节点满足以下属性，那么主节点将向从节点返回 FAILOVER_AUTH_GRANTED 授权，同意从节点的升级要求：
* 发送授权请求的是一个从节点，并且它所属的主节点处于 FAIL 状态。
* 在已下线主节点的所有从节点中，这个从节点的节点 ID 在排序中是最小的。
* 这个从节点处于正常的运行状态：它没有被标记为 FAIL 状态，也没有被标记为 PFAIL 状态。

一旦某个从节点在给定的时限内得到大部分主节点的授权，它就会开始执行以下故障转移操作：
* 通过 PONG 数据包（packet）告知其他节点，这个节点现在是主节点了。
* 通过 PONG 数据包告知其他节点，这个节点是一个已升级的从节点（promoted slave）。
* 接管（claiming）所有由已下线主节点负责处理的哈希槽。
* 显式地向所有节点广播一个 PONG 数据包，加速其他节点识别这个节点的进度，而不是等待定时的 PING / PONG 数据包。
* 所有其他节点都会根据新的主节点对配置进行相应的更新，特别地：所有被新的主节点接管的槽会被更新。
* 已下线主节点的所有从节点会察觉到 PROMOTED 标志，并开始对新的主节点进行复制。
如果已下线的主节点重新回到上线状态，那么它会察觉到 PROMOTED 标志，并将自身调整为现任主节点的从节点。
在集群的生命周期中，如果一个带有 PROMOTED 标识的主节点因为某些原因转变成了从节点，那么该节点将丢失它所带有的 PROMOTED 标识。