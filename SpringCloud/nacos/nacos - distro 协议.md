# Distro 协议流程
https://www.cnblogs.com/longge2005/archive/2004/01/13/13954856.html  
在Nacos的Instance(实例)中提供了一个ephemeral字段，这个字段是bool类型，这个字段和ZK中的含义差不多，都代表的是否是临时节点，在Nacos中如果是临时节点就会使用AP协议，如果不是临时节点就会走CP。  

当然在注册中心中所有的实例其实默认都是临时节点  
https://cloud.tencent.com/developer/article/1650014  

1. nacos启动首先从其他远程节点同步全部数据
2. nacos每个节点是平等的都可以处理写入请求，同时把新数据同步到其他节点
3. 每个节点只负责部分数据，定时发送自己负责数据校验值到其他节点来保持数据一致性

## Distro 协议
Distro 协议被定位为临时数据的一致性协议 (AP)：该类型协议， 不需要把数据存储到磁盘或者数据库 ，因为临时数据通常和服务器保持一个session会话， 该会话只要存在，数据就不会丢失

* 专门为了注册中心而创造出的协议；

* 客户端与服务端有两个重要的交互，服务注册与心跳发送；

* 客户端以服务为维度向服务端注册，注册后每隔一段时间向服务端发送一次心跳，心跳包需要带上注册服务的全部信息，在客户端看来，服务端节点对等，所以请求的节点是随机的；

* 客户端请求失败则换一个节点重新发送请求；

* 服务端节点都存储所有数据，但每个节点只负责其中一部分服务，在接收到客户端的“写”（注册、心跳、下线等）请求后，服务端节点判断请求的服务是否为自己负责，如果是，则处理，否则交由负责的节点处理；

* 每个服务端节点主动发送健康检查到其他节点，响应的节点被该节点视为健康节点；

* 服务端在接收到客户端的服务心跳后，如果该服务不存在，则将该心跳请求当做注册请求来处理；

* 服务端如果长时间未收到客户端心跳，则下线该服务；

* 负责的节点在接收到服务注册、服务心跳等写请求后将数据写入后即返回，后台异步地将数据同步给其他节点；

*  节点在收到读请求后直接从本机获取后返回，无论数据是否为最新

## 纯内存保存
https://cloud.tencent.com/developer/article/1650014  
Distro是用ConcurrentHashMap作为存储的容器，不需要使用额外的文件进行存储

## 最终一致性


## 水平扩展
https://cloud.tencent.com/developer/article/1650014  
在Distro中并不是每个节点都可以处理所有的读请求，但是写请求并不是每个节点都可以处理的，每个节点会根据key的hash值来判断是否应该是自己处理。写请求访问的是域名这个是会随机打到每个节点上的